// Shared Prisma schema for both Bot and API
// This is the single source of truth for the database schema

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "mongodb"
  url      = env("DB_URL")
}

model GuildConfig {
  id                     String          @id @default(auto()) @map("_id") @db.ObjectId
  guildId                String          @unique
  maxMessagesCleared     Int             @default(100)
  musicChannelId         String          @default("")
  defaultRepeatMode      Int             @default(0)
  reactionRoleChannels   String[]        @default([])
  logReactionRoles       Boolean         @default(false)
  welcomeChannelId       String?
  goodbyeChannelId       String?
  welcomeEnabled         Boolean         @default(true)
  goodbyeEnabled         Boolean         @default(true)
  preferredLanguage      String          @default("en")
  // Ticket system fields
  ticketChannelId        String?
  ticketCategoryId       String?
  useTicketThreads       Boolean         @default(true)
  ticketOnCallRoleId     String?
  ticketSilentClaim      Boolean         @default(true)
  // Ticket access control
  ticketAccessType       String?
  ticketAccessRoleId     String?
  ticketAccessPermission String?
  ticketLogChannelId     String?
  // Relations - new LogSettings model handles all logging configuration
  logSettings            LogSettings?    @relation(fields: [logSettingsId], references: [id])
  appealSettings         AppealSettings? @relation(fields: [appealSettingsId], references: [id])
  logSettingsId          String?         @db.ObjectId
  appealSettingsId       String?         @db.ObjectId
  // New fields
  moderatorRoleIds       String[]        @default([])
  welcomeStats           Json?
  /// Send DMs to users when a moderation action is taken by default
  notify_user            Boolean         @default(false)
  /// Per-action moderation case behaviour. Keys are action names, values are "NEW" or "UPDATE".
  moderation_case_rules  Json?
  /// Channel where user reports should be sent
  reportChannelId        String?
  /// Role to ping when a new user report is submitted
  reportPingRoleId       String?
}

model LogSettings {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  guildId         String        @unique
  channelRouting  Json
  ignoredUsers    String[]      @default([])
  ignoredRoles    String[]      @default([])
  ignoredChannels String[]      @default([])
  enabledLogTypes String[]      @default([])
  customFormats   Json?
  filterRules     Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  GuildConfig     GuildConfig[]
}

model AppealSettings {
  id                    String        @id @default(auto()) @map("_id") @db.ObjectId
  guildId               String        @unique
  discordBotEnabled     Boolean       @default(true)
  webFormEnabled        Boolean       @default(false)
  emailEnabled          Boolean       @default(false)
  separateServerEnabled Boolean       @default(false)
  appealChannelId       String?
  appealServerId        String?
  webFormUrl            String?
  appealEmail           String?
  appealReceived        String?
  appealApproved        String?
  appealDenied          String?
  appealCooldown        Int           @default(86400)
  maxAppealsPerUser     Int           @default(3)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  GuildConfig           GuildConfig[]
}

model ModerationCase {
  id           String          @id @default(auto()) @map("_id") @db.ObjectId
  caseNumber   Int
  guildId      String
  userId       String
  moderatorId  String
  type         String
  reason       String?
  evidence     String[]
  duration     Int?
  expiresAt    DateTime?
  isActive     Boolean         @default(true)
  severity     String          @default("LOW")
  points       Int             @default(0)
  canAppeal    Boolean         @default(true)
  appealedAt   DateTime?
  appealStatus String?
  context      Json?
  dmSent       Boolean         @default(false)
  publicNote   String?
  staffNote    String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  notes        CaseNote[]
  appeals      CaseAppeal[]
  logs         ModerationLog[]

  @@unique([guildId, caseNumber])
  @@index([guildId, userId])
  @@index([guildId, type])
  @@index([expiresAt])
}

model CaseNote {
  id         String         @id @default(auto()) @map("_id") @db.ObjectId
  caseId     String         @db.ObjectId
  case       ModerationCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  authorId   String
  content    String
  isInternal Boolean        @default(false)
  createdAt  DateTime       @default(now())

  @@index([caseId])
}

model CaseAppeal {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  caseId         String         @db.ObjectId
  case           ModerationCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  userId         String
  appealMethod   String
  reason         String
  status         String         @default("PENDING")
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?
  evidence       String[]
  communications Json[]         @default([])
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([caseId])
  @@index([userId, status])
}

model ModerationLog {
  id             String          @id @default(auto()) @map("_id") @db.ObjectId
  guildId        String
  logType        String
  userId         String?
  channelId      String?
  roleId         String?
  caseId         String?         @db.ObjectId
  case           ModerationCase? @relation(fields: [caseId], references: [id])
  before         Json?
  after          Json?
  metadata       Json?
  content        String?
  attachments    String[]
  embeds         Json[]
  executorId     String?
  reason         String?
  sentToChannels String[]        @default([])
  timestamp      DateTime        @default(now())

  @@index([guildId, logType])
  @@index([guildId, timestamp])
  @@index([userId])
  @@index([channelId])
}

model Ticket {
  id             String          @id @default(auto()) @map("_id") @db.ObjectId
  ticketNumber   Int
  guildId        String
  userId         String
  channelId      String
  threadId       String?
  category       String
  title          String
  description    String?
  status         String          @default("OPEN")
  assignedTo     String?
  tags           String[]        @default([])
  closedReason   String?
  closedBy       String?
  closedAt       DateTime?
  lastActivity   DateTime        @default(now())
  allowUserClose Boolean         @default(true)
  isAnonymous    Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  messages       TicketMessage[]

  @@unique([guildId, ticketNumber])
  @@index([guildId, status])
  @@index([assignedTo])
}

model TicketMessage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ticketId    String   @db.ObjectId
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  messageId   String
  userId      String
  userIcon    String
  content     String
  attachments String[]
  embeds      Json[]
  isSystemMsg Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([ticketId])
  @@index([messageId])
}

model Alias {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId         String
  name            String
  content         String
  category        String   @default("GENERAL")
  variables       String[] @default([])
  permissions     String[] @default([])
  usageCount      Int      @default(0)
  isGlobal        Boolean  @default(false)
  allowedChannels String[] @default([])
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([guildId, name])
  @@index([guildId, category])
}

model AutoModRule {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId        String
  name           String
  type           String
  enabled        Boolean   @default(true)
  triggers       Json
  whitelist      String[]  @default([])
  sensitivity    String    @default("MEDIUM")
  actions        Json
  escalation     Json?
  exemptRoles    String[]  @default([])
  exemptChannels String[]  @default([])
  exemptUsers    String[]  @default([])
  targetChannels String[]  @default([])
  logChannel     String?
  logActions     Boolean   @default(true)
  triggerCount   Int       @default(0)
  lastTriggered  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String

  @@unique([guildId, name])
  @@index([guildId, enabled])
}

model ScheduledAction {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId      String
  userId       String
  type         String
  caseId       String?   @db.ObjectId
  data         Json? // Additional data needed for action
  scheduledFor DateTime
  isExecuted   Boolean   @default(false)
  executedAt   DateTime?
  error        String? // Error message if execution failed
  retryCount   Int       @default(0)
  maxRetries   Int       @default(3)
  createdAt    DateTime  @default(now())

  @@index([scheduledFor, isExecuted])
  @@index([guildId, userId])
}

// User infraction points system
model UserInfractions {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId      String
  userId       String
  totalPoints  Int       @default(0)
  strikes      Int       @default(0) // Number of major infractions
  lastIncident DateTime?

  // Point decay system
  pointDecay Json? // Configuration for automatic point reduction

  // Temporary restrictions
  restrictions Json[] @default([]) // Temporary channel/role restrictions

  updatedAt DateTime @updatedAt

  @@unique([guildId, userId])
  @@index([guildId, totalPoints])
}

// Comprehensive log type definitions
model LogType {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  name           String  @unique // MESSAGE_DELETE, MEMBER_JOIN, etc.
  category       String // MESSAGE, MEMBER, ROLE, CHANNEL, etc.
  description    String
  severity       String  @default("INFO") // DEBUG, INFO, WARN, ERROR, CRITICAL
  defaultChannel String? // Default channel type for this log
  isEnabled      Boolean @default(true)

  // Template configuration
  embedTemplate   Json? // Default embed template
  messageTemplate String? // Default message template
}

// Permission management system
model CommandPermission {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId            String
  commandName        String
  permissionLevel    String // Enum as string
  discordPermissions String[] @default([])
  requiredRoles      String[] @default([])
  allowedUsers       String[] @default([])
  deniedUsers        String[] @default([])
  isConfigurable     Boolean  @default(true)
  createdBy          String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([guildId, commandName])
  @@index([guildId])
}

// Maintenance mode
model MaintenanceMode {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId      String   @unique
  isEnabled    Boolean  @default(false)
  allowedUsers String[] @default([])
  reason       String?
  enabledBy    String
  enabledAt    DateTime @default(now())
}

// Permission audit log
model PermissionAuditLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  commandName String?
  action      String
  oldValue    Json?
  newValue    Json?
  userId      String
  reason      String?
  timestamp   DateTime @default(now())

  @@index([guildId])
  @@index([timestamp])
}

// Custom roles system for RBAC
model CustomRole {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  name        String
  permissions String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments CustomRoleAssignment[]

  @@unique([guildId, name])
  @@index([guildId])
}

// Custom role assignments
model CustomRoleAssignment {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  guildId    String
  userId     String
  roleId     String     @db.ObjectId
  role       CustomRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedBy String
  assignedAt DateTime   @default(now())
  expiresAt  DateTime?
  isActive   Boolean    @default(true)
  reason     String?

  @@unique([guildId, userId, roleId])
  @@index([guildId, userId])
  @@index([expiresAt])
}

// Reaction Role System
model ReactionRole {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String
  channelId String
  messageId String
  emoji     String // Unicode or custom emoji ID
  roleIds   String[] // Multiple roles can be assigned to one reaction
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs ReactionRoleLog[]

  @@unique([messageId, emoji])
  @@index([guildId])
  @@index([messageId])
}

// Reaction Role Messages (for builder-created embeds)
model ReactionRoleMessage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  channelId   String
  messageId   String   @unique
  title       String
  description String?
  embedColor  String?
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([guildId])
}

// Reaction Role Activity Logs
model ReactionRoleLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String
  userId    String
  messageId String
  emoji     String
  roleId    String
  action    String // ADD or REMOVE
  timestamp DateTime @default(now())

  reactionRole ReactionRole @relation(fields: [messageId, emoji], references: [messageId, emoji])

  @@index([guildId])
  @@index([userId])
  @@index([messageId])
}

// Poll system
model Poll {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId       String
  channelId     String
  messageId     String    @unique
  title         String
  description   String?
  options       String[]
  votes         Json?
  allowMultiple Boolean   @default(false)
  isActive      Boolean   @default(true)
  createdBy     String
  createdAt     DateTime  @default(now())
  endsAt        DateTime?

  @@index([guildId])
  @@index([isActive])
}

// Giveaway system
model Giveaway {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId       String
  channelId     String
  messageId     String    @unique
  giveawayId    String    @unique // Short ID for users
  hostId        String // User who created the giveaway
  title         String
  description   String?
  prize         String
  winnersCount  Int       @default(1)
  requirements  String? // Text description of requirements
  requiredRoles String[]  @default([]) // Required role IDs
  blockedRoles  String[]  @default([]) // Blocked role IDs  
  minimumLevel  Int? // Minimum user level if applicable
  isActive      Boolean   @default(true)
  hasEnded      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  endsAt        DateTime
  endedAt       DateTime?
  winners       String[]  @default([]) // Winner user IDs
  totalEntries  Int       @default(0)

  // Entry tracking
  entries GiveawayEntry[]

  @@index([guildId, isActive])
  @@index([endsAt, isActive])
  @@index([guildId, hostId])
}

model GiveawayEntry {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  giveawayId String   @db.ObjectId
  giveaway   Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)
  userId     String
  guildId    String
  enteredAt  DateTime @default(now())

  @@unique([giveawayId, userId])
  @@index([giveawayId])
  @@index([userId])
}

// Webhook system
model Webhook {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId    String
  name       String
  url        String
  secret     String?
  isActive   Boolean   @default(true)
  events     String[]  @default([]) // Which events to send
  headers    Json? // Custom headers
  timeout    Int       @default(5000) // Timeout in ms
  retryCount Int       @default(3)
  retryDelay Int       @default(1000) // Base delay in ms
  lastUsed   DateTime?
  failCount  Int       @default(0)
  createdBy  String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  logs       WebhookLog[]
  deliveries WebhookDelivery[]

  @@unique([guildId, name])
  @@index([guildId, isActive])
}

model WebhookLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  webhookId String   @db.ObjectId
  webhook   Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  guildId   String
  event     String
  payload   Json
  response  Json?
  status    String // SUCCESS, FAILED, TIMEOUT
  httpCode  Int?
  error     String?
  duration  Int? // Response time in ms
  timestamp DateTime @default(now())

  @@index([webhookId, timestamp])
  @@index([guildId, event])
  @@index([status])
}

model WebhookDelivery {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  webhookId   String    @db.ObjectId
  webhook     Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  guildId     String
  event       String
  payload     Json
  status      String    @default("PENDING") // PENDING, SUCCESS, FAILED, ABANDONED
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  nextRetry   DateTime?
  lastError   String?
  httpCode    Int?
  response    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([webhookId, status])
  @@index([nextRetry])
  @@index([guildId, event])
}

// Starboard system
model StarboardSettings {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId         String
  channelId       String?
  emoji           String   @default("‚≠ê")
  threshold       Int      @default(3)
  selfStar        Boolean  @default(false)
  allowNsfw       Boolean  @default(false)
  ignoredChannels String[] @default([])
  ignoredRoles    String[] @default([])
  ignoredUsers    String[] @default([])
  color           String   @default("#FFD700")
  isEnabled       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([guildId])
}

model StarboardMessage {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId            String
  channelId          String // Original channel
  messageId          String   @unique // Original message
  starboardChannelId String // Starboard channel
  starboardMessageId String?  @unique // Message in starboard
  authorId           String // Original author
  content            String?
  attachments        String[] @default([])
  embeds             Json[]   @default([])
  starCount          Int      @default(0)
  lastUpdated        DateTime @default(now())
  createdAt          DateTime @default(now())

  reactions StarboardReaction[]

  @@index([guildId, starCount])
}

model StarboardReaction {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  messageId String           @db.ObjectId
  message   StarboardMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  guildId   String
  emoji     String
  addedAt   DateTime         @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

// Reminder system
model Reminder {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId      String
  userId       String
  channelId    String
  content      String
  reminderTime DateTime
  isRecurring  Boolean   @default(false)
  recurring    Json? // Cron pattern or interval data
  isActive     Boolean   @default(true)
  isExecuted   Boolean   @default(false)
  executedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  logs ReminderLog[]

  @@index([guildId, userId])
  @@index([reminderTime, isActive])
  @@index([isExecuted, isActive])
}

model ReminderLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  reminderId String   @db.ObjectId
  reminder   Reminder @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  guildId    String
  userId     String
  status     String // SENT, FAILED, CANCELLED
  error      String?
  executedAt DateTime @default(now())

  @@index([reminderId])
  @@index([guildId, userId])
}

// Application system
model ApplicationForm {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId        String
  name           String
  description    String?
  isActive       Boolean  @default(true)
  isMultiStep    Boolean  @default(false)
  maxSubmissions Int? // Per user limit
  fields         Json // Form field definitions
  workflow       Json? // Multi-step workflow definition
  autoRole       String? // Role to assign on approval
  logChannelId   String? // Where to log submissions
  pingRoleId     String? // Role to ping on new submissions
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  applications Application[]
  steps        ApplicationStep[]

  @@unique([guildId, name])
  @@index([guildId, isActive])
}

model ApplicationStep {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  formId      String          @db.ObjectId
  form        ApplicationForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  stepNumber  Int
  name        String
  description String?
  fields      Json // Step-specific fields
  isRequired  Boolean         @default(true)
  conditions  Json? // Conditional logic

  @@unique([formId, stepNumber])
  @@index([formId])
}

model Application {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  formId      String          @db.ObjectId
  form        ApplicationForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  guildId     String
  userId      String
  status      String          @default("PENDING") // PENDING, APPROVED, REJECTED, IN_REVIEW
  currentStep Int             @default(1)
  responses   Json // All form responses
  reviewerId  String?
  reviewNotes String?
  reviewedAt  DateTime?
  submittedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([formId, userId])
  @@index([guildId, status])
  @@index([userId, status])
}

// Entertainment system (no economy)
model TriviaQuestion {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId       String? // null for global questions
  category      String
  difficulty    String   @default("MEDIUM") // EASY, MEDIUM, HARD
  question      String
  correctAnswer String
  wrongAnswers  String[] // Array of incorrect options
  explanation   String?
  isActive      Boolean  @default(true)
  timesUsed     Int      @default(0)
  correctCount  Int      @default(0)
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([guildId, category])
  @@index([difficulty, isActive])
}

model GameSession {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId      String
  channelId    String
  gameType     String // TRIVIA, POLL, HANGMAN, etc.
  status       String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  hostId       String
  participants String[]  @default([])
  gameData     Json // Game-specific data
  scores       Json? // Player scores
  settings     Json? // Game settings
  messageId    String? // Game message ID
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  duration     Int? // Session duration in seconds

  @@index([guildId, gameType])
  @@index([status, startedAt])
  @@index([hostId])
}

// --------------------------------------------------
// Level history (tracks each time a user reaches a level)
model LevelHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String
  userId    String
  level     Int
  reachedAt DateTime @default(now())

  @@index([guildId, userId])
}

// --------------------------------------------------
// Token blacklist for logout / revocation
model TokenBlacklist {
  jti       String   @id @map("_id")
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

// --------------------------------------------------
// Game settings (entertainment / economy)
model GameSettings {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId         String   @unique
  enabled         Boolean  @default(true)
  allowedChannels String[] @default([])
  triviaEnabled   Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --------------------------------------------------
// Music feature settings
model MusicSettings {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId          String   @unique
  enabled          Boolean  @default(true)
  djRoleId         String?
  maxQueueSize     Int      @default(100)
  maxTrackDuration Int      @default(600000)
  allowNSFW        Boolean  @default(false)
  defaultVolume    Int      @default(50)
  autoLeave        Boolean  @default(true)
  autoLeaveDelay   Int      @default(300000)
  allowedChannels  String[] @default([])
  blockedChannels  String[] @default([])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// --------------------------------------------------
// Level reward model
model LevelReward {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  guildId          String
  level            Int
  roleId           String
  removeOnDemotion Boolean @default(false)
}

model User {
  id             String   @id @map("_id") @db.ObjectId
  discordId      String   @unique
  username       String
  discriminator  String
  avatar         String?
  email          String?  @unique
  accessToken    String
  refreshToken   String
  tokenExpiresAt DateTime
  lastLogin      DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

/// Table storing user-submitted message reports
model UserReport {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId      String
  reporterId   String
  reportedUser String
  messageId    String
  channelId    String
  link         String
  reason       String
  status       String    @default("OPEN")
  createdAt    DateTime  @default(now())
  resolvedAt   DateTime?
  resolvedBy   String?
  resolution   String?

  @@index([guildId, status])
}

/// -------------------------
/// Phase 1 Additions (Queue, Events, Permissions)
/// -------------------------

model QueueJob {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  queueName   String
  jobType     String
  payload     Json
  status      String // waiting, active, completed, failed
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  createdAt   DateTime  @default(now())
  processedAt DateTime?
  failedAt    DateTime?
  errorMsg    String?

  @@index([queueName, status])
  @@index([createdAt])
}

model EventDiscord {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  type      String
  guildId   String?
  userId    String?
  channelId String?
  messageId String?
  payload   Json
  metadata  Json?
  createdAt DateTime  @default(now())
  ttl       DateTime?

  @@index([type, guildId, createdAt])
  @@index([userId, createdAt])
  @@index([ttl])
}

model EventGithub {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  type       String
  repository String?
  payload    Json
  metadata   Json?
  createdAt  DateTime  @default(now())
  ttl        DateTime?

  @@index([type, repository, createdAt])
  @@index([ttl])
}

model RolePermission {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  roleId      String
  permissions String // Bitfield string
  customNodes Json?
  updatedAt   DateTime @updatedAt

  @@unique([guildId, roleId])
  @@index([guildId])
}

model UserPermission {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  userId      String
  permissions String // Bitfield string
  customNodes Json?
  updatedAt   DateTime @updatedAt

  @@unique([guildId, userId])
  @@index([guildId])
}

// Ticket role configuration
model TicketRoleConfig {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId         String   @unique
  autoAddRoles    String[] @default([])
  persistentRoles String[] @default([])
  roleHierarchy   Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  supportRoles   TicketSupportRole[]
  categoryRoles  TicketCategoryRole[]
  temporaryRoles TicketTemporaryRole[]
}

// Ticket support roles
model TicketSupportRole {
  id       String           @id @default(auto()) @map("_id") @db.ObjectId
  configId String
  roleId   String
  config   TicketRoleConfig @relation(fields: [configId], references: [guildId], onDelete: Cascade)

  @@unique([configId, roleId])
}

// Category-specific roles
model TicketCategoryRole {
  id       String           @id @default(auto()) @map("_id") @db.ObjectId
  configId String
  category String
  roleIds  String[]
  config   TicketRoleConfig @relation(fields: [configId], references: [guildId], onDelete: Cascade)

  @@unique([configId, category])
}

// Temporary roles
model TicketTemporaryRole {
  id       String           @id @default(auto()) @map("_id") @db.ObjectId
  configId String
  roleId   String
  config   TicketRoleConfig @relation(fields: [configId], references: [guildId], onDelete: Cascade)

  @@unique([configId, roleId])
}

// Ticket role assignments
model TicketRoleAssignment {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  userId       String
  roleId       String
  ticketId     String
  isPersistent Boolean   @default(false)
  expiresAt    DateTime?
  assignedAt   DateTime  @default(now())

  @@unique([userId, roleId, ticketId])
  @@index([ticketId])
  @@index([userId])
  @@index([expiresAt])
}

// Server statistics snapshots
model ServerStatsSnapshot {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId              String
  memberCount          Int
  onlineCount          Int
  channelCount         Int
  roleCount            Int
  messageCount24h      Int      @default(0)
  moderationCases24h   Int      @default(0)
  ticketsCreated24h    Int      @default(0)
  commandsExecuted24h  Int      @default(0)
  voiceMinutes24h      Int      @default(0)
  reactionRoleUsage24h Int      @default(0)
  timestamp            DateTime @default(now())

  @@index([guildId, timestamp])
  @@index([timestamp])
}

// Message statistics (for tracking message activity)
model MessageStats {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String
  channelId String
  userId    String
  messageId String   @unique
  content   String?
  timestamp DateTime @default(now())
  edited    Boolean  @default(false)
  deleted   Boolean  @default(false)

  @@index([guildId, timestamp])
  @@index([channelId, timestamp])
  @@index([userId, timestamp])
}

// Voice activity tracking
model VoiceActivity {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String
  channelId String
  userId    String
  joinedAt  DateTime
  leftAt    DateTime?
  duration  Int? // in seconds
  isActive  Boolean   @default(true)

  @@index([guildId, joinedAt])
  @@index([userId, joinedAt])
  @@index([channelId, joinedAt])
}

// User activity summary
model UserActivitySummary {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId          String
  userId           String
  date             DateTime // Date for the summary (daily)
  messageCount     Int      @default(0)
  voiceMinutes     Int      @default(0)
  commandsExecuted Int      @default(0)
  reactionsAdded   Int      @default(0)
  lastActive       DateTime @default(now())

  @@unique([guildId, userId, date])
  @@index([guildId, date])
  @@index([userId, date])
}

// Ticket categories with custom workflows
model TicketCategory {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId         String
  name            String
  description     String?
  emoji           String?
  color           String?  @default("#5865F2")
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)
  maxTickets      Int? // Max tickets per user in this category
  autoAssignRoles String[] @default([])
  requiredRoles   String[] @default([]) // Roles required to create tickets
  allowedChannels String[] @default([]) // Channels where category can be used
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Workflow configuration
  workflows TicketCategoryWorkflow[]
  fields    TicketCategoryField[]

  @@unique([guildId, name])
  @@index([guildId, isActive])
}

// Custom workflows for ticket categories
model TicketCategoryWorkflow {
  id          String               @id @default(auto()) @map("_id") @db.ObjectId
  categoryId  String               @db.ObjectId
  category    TicketCategory       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isDefault   Boolean              @default(false)
  steps       TicketWorkflowStep[]

  @@unique([categoryId, name])
}

// Workflow steps
model TicketWorkflowStep {
  id             String                 @id @default(auto()) @map("_id") @db.ObjectId
  workflowId     String                 @db.ObjectId
  workflow       TicketCategoryWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stepOrder      Int
  name           String
  description    String?
  type           String // MESSAGE, ROLE_ASSIGN, STATUS_CHANGE, ESCALATION, etc.
  config         Json // Step-specific configuration
  conditions     Json? // Conditions for step execution
  autoExecute    Boolean                @default(false)
  timeoutMinutes Int? // Auto-execute after timeout

  @@unique([workflowId, stepOrder])
  @@index([workflowId])
}

// Custom fields for ticket categories
model TicketCategoryField {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  categoryId   String         @db.ObjectId
  category     TicketCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name         String
  label        String
  description  String?
  type         String // TEXT, TEXTAREA, SELECT, MULTISELECT, BOOLEAN, NUMBER, DATE
  required     Boolean        @default(false)
  options      String[]       @default([]) // For SELECT/MULTISELECT fields
  defaultValue String?
  validation   Json? // Validation rules
  displayOrder Int            @default(0)

  @@unique([categoryId, name])
  @@index([categoryId])
}

// Ticket field values
model TicketFieldValue {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ticketId  String   @db.ObjectId
  fieldName String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ticketId, fieldName])
  @@index([ticketId])
}

// Ticket workflow executions
model TicketWorkflowExecution {
  id             String                        @id @default(auto()) @map("_id") @db.ObjectId
  ticketId       String                        @db.ObjectId
  workflowId     String                        @db.ObjectId
  currentStep    Int                           @default(0)
  status         String                        @default("RUNNING") // RUNNING, COMPLETED, FAILED, PAUSED
  startedAt      DateTime                      @default(now())
  completedAt    DateTime?
  error          String?
  stepExecutions TicketWorkflowStepExecution[]

  @@unique([ticketId, workflowId])
  @@index([ticketId])
  @@index([workflowId])
}

// Individual step executions
model TicketWorkflowStepExecution {
  id          String                  @id @default(auto()) @map("_id") @db.ObjectId
  executionId String                  @db.ObjectId
  execution   TicketWorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  stepId      String                  @db.ObjectId
  stepOrder   Int
  status      String                  @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, SKIPPED
  startedAt   DateTime?
  completedAt DateTime?
  error       String?
  result      Json? // Step execution result

  @@unique([executionId, stepOrder])
  @@index([executionId])
}

// Ticket analytics and metrics
model TicketAnalytics {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId              String
  ticketId             String    @db.ObjectId
  category             String
  assigneeId           String?
  createdAt            DateTime
  firstResponseAt      DateTime?
  firstResponseTime    Int? // in minutes
  resolvedAt           DateTime?
  resolutionTime       Int? // in minutes
  closedAt             DateTime?
  totalResponseTime    Int? // total time to respond to all messages
  messageCount         Int       @default(0)
  staffMessageCount    Int       @default(0)
  userMessageCount     Int       @default(0)
  escalationCount      Int       @default(0)
  satisfactionScore    Int? // 1-5 scale
  satisfactionFeedback String?
  tags                 String[]  @default([])
  priority             String    @default("NORMAL") // LOW, NORMAL, HIGH, URGENT

  @@unique([ticketId])
  @@index([guildId, category])
  @@index([guildId, createdAt])
  @@index([assigneeId])
}

// Daily ticket statistics aggregation
model TicketDailyStats {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId    String
  date       DateTime // Date for the stats (daily)
  category   String? // null for all categories
  assigneeId String? // null for all assignees

  // Ticket counts
  ticketsCreated   Int @default(0)
  ticketsResolved  Int @default(0)
  ticketsClosed    Int @default(0)
  ticketsEscalated Int @default(0)

  // Response metrics
  avgFirstResponseTime Float? // in minutes
  avgResolutionTime    Float? // in minutes
  totalResponseTime    Int    @default(0)

  // Satisfaction metrics
  avgSatisfactionScore  Float?
  satisfactionResponses Int    @default(0)

  // Message metrics
  totalMessages Int @default(0)
  staffMessages Int @default(0)
  userMessages  Int @default(0)

  @@unique([guildId, date, category, assigneeId])
  @@index([guildId, date])
  @@index([category])
  @@index([assigneeId])
}

// Ticket satisfaction surveys
model TicketSatisfactionSurvey {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  guildId    String
  ticketId   String  @db.ObjectId
  userId     String
  assigneeId String?
  category   String

  // Survey responses
  overallSatisfaction Int // 1-5 scale
  responseSpeed       Int? // 1-5 scale
  helpfulness         Int? // 1-5 scale
  professionalism     Int? // 1-5 scale
  resolutionQuality   Int? // 1-5 scale

  // Feedback
  feedback       String?
  suggestions    String?
  wouldRecommend Boolean?

  // Metadata
  submittedAt   DateTime @default(now())
  surveyVersion String   @default("1.0")

  @@unique([ticketId])
  @@index([guildId, category])
  @@index([assigneeId])
  @@index([submittedAt])
}

// Performance metrics for staff members
model TicketStaffMetrics {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  staffId     String
  period      String // DAILY, WEEKLY, MONTHLY
  periodStart DateTime
  periodEnd   DateTime

  // Ticket metrics
  ticketsAssigned Int @default(0)
  ticketsResolved Int @default(0)
  ticketsClosed   Int @default(0)

  // Performance metrics
  avgFirstResponseTime Float? // in minutes
  avgResolutionTime    Float? // in minutes
  avgSatisfactionScore Float?
  totalWorkingTime     Int    @default(0) // in minutes

  // Quality metrics
  escalationsReceived Int @default(0)
  escalationsGiven    Int @default(0)
  reopenedTickets     Int @default(0)

  // Activity metrics
  messagesPosted   Int @default(0)
  actionsPerformed Int @default(0)

  updatedAt DateTime @updatedAt

  @@unique([guildId, staffId, period, periodStart])
  @@index([guildId, period])
  @@index([staffId])
}

// Ticket templates for quick ticket creation
model TicketTemplate {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId         String
  name            String
  description     String?
  category        String
  title           String
  content         String?
  priority        String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  tags            String[] @default([])
  autoAssignRoles String[] @default([])
  autoAssignUsers String[] @default([])
  isActive        Boolean  @default(true)
  isPublic        Boolean  @default(true) // Can be used by regular users
  usageCount      Int      @default(0)
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Template configuration
  fields  TicketTemplateField[]
  actions TicketTemplateAction[]

  @@unique([guildId, name])
  @@index([guildId, category])
  @@index([guildId, isActive])
}

// Custom fields for ticket templates
model TicketTemplateField {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  templateId   String         @db.ObjectId
  template     TicketTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  name         String
  label        String
  description  String?
  type         String // TEXT, TEXTAREA, SELECT, MULTISELECT, BOOLEAN, NUMBER, DATE, USER, ROLE, CHANNEL
  required     Boolean        @default(false)
  options      String[]       @default([]) // For SELECT/MULTISELECT fields
  defaultValue String?
  placeholder  String?
  validation   Json? // Validation rules
  displayOrder Int            @default(0)

  @@unique([templateId, name])
  @@index([templateId])
}

// Automated actions for ticket templates
model TicketTemplateAction {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  templateId     String         @db.ObjectId
  template       TicketTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  name           String
  type           String // MESSAGE, ROLE_ASSIGN, NOTIFICATION, WORKFLOW_TRIGGER, STATUS_CHANGE
  trigger        String         @default("ON_CREATE") // ON_CREATE, ON_ASSIGN, ON_FIRST_RESPONSE, DELAYED
  delay          Int? // Delay in minutes for DELAYED trigger
  config         Json // Action-specific configuration
  conditions     Json? // Conditions for action execution
  isActive       Boolean        @default(true)
  executionOrder Int            @default(0)

  @@unique([templateId, name])
  @@index([templateId])
}

// Template usage tracking
model TicketTemplateUsage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  templateId  String   @db.ObjectId
  ticketId    String   @db.ObjectId
  userId      String
  fieldValues Json // Field values used when creating the ticket
  usedAt      DateTime @default(now())

  @@unique([templateId, ticketId])
  @@index([templateId])
  @@index([ticketId])
  @@index([userId])
}

// Pre-defined ticket types with common configurations
model TicketType {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId          String
  name             String
  description      String?
  emoji            String?
  color            String?  @default("#5865F2")
  category         String
  priority         String   @default("NORMAL")
  estimatedTime    Int? // Estimated resolution time in minutes
  slaTime          Int? // SLA time in minutes
  autoClose        Boolean  @default(false)
  autoCloseTime    Int? // Auto close time in hours
  requiresApproval Boolean  @default(false)
  approvalRoles    String[] @default([])
  isActive         Boolean  @default(true)
  sortOrder        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([guildId, name])
  @@index([guildId, category])
  @@index([guildId, isActive])
}

// Many-to-many relation for ticket types and templates
model TicketTypeTemplate {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  typeId     String  @db.ObjectId
  templateId String  @db.ObjectId
  isDefault  Boolean @default(false)

  @@unique([typeId, templateId])
  @@index([typeId])
  @@index([templateId])
}

// Template categories for organization
model TicketTemplateCategory {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  name        String
  description String?
  emoji       String?
  color       String? @default("#5865F2")
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  @@unique([guildId, name])
  @@index([guildId, isActive])
}

// Ticket user management and permissions
model TicketUser {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  ticketId    String    @db.ObjectId
  userId      String
  addedBy     String
  permissions String[]  @default([]) // VIEW, MESSAGE, MANAGE, CLOSE
  addedAt     DateTime  @default(now())
  removedAt   DateTime?
  removedBy   String?
  isActive    Boolean   @default(true)
  reason      String? // Reason for adding/removing

  @@unique([ticketId, userId])
  @@index([ticketId])
  @@index([userId])
  @@index([addedBy])
}

// Ticket permission presets
model TicketPermissionPreset {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  name        String
  description String?
  permissions String[] @default([])
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([guildId, name])
  @@index([guildId, isActive])
}

// Ticket access requests
model TicketAccessRequest {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  ticketId    String    @db.ObjectId
  userId      String
  requestedBy String
  reason      String?
  status      String    @default("PENDING") // PENDING, APPROVED, DENIED
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?
  requestedAt DateTime  @default(now())
  expiresAt   DateTime?

  @@unique([ticketId, userId])
  @@index([ticketId])
  @@index([userId])
  @@index([status])
}

// Ticket user activity tracking
model TicketUserActivity {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ticketId    String   @db.ObjectId
  userId      String
  action      String // ADDED, REMOVED, PERMISSION_CHANGED, MESSAGE_SENT, FILE_UPLOADED
  details     Json? // Additional action details
  performedBy String
  timestamp   DateTime @default(now())

  @@index([ticketId])
  @@index([userId])
  @@index([timestamp])
}

// Ticket sharing configurations
model TicketSharingConfig {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId               String   @unique
  allowUserAdditions    Boolean  @default(true)
  requireApproval       Boolean  @default(false)
  approvalRoles         String[] @default([])
  maxUsersPerTicket     Int      @default(10)
  defaultPermissions    String[] @default(["VIEW", "MESSAGE"])
  autoRemoveInactive    Boolean  @default(false)
  inactiveThresholdDays Int      @default(7)
  logChannel            String?
}
